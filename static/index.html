<!doctype html>
<meta charset="utf-8">
<title>로또 예측 — 풀 UI</title>
<style>
  body{margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:#111827;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px}
  .ok{color:#34d399}.warn{color:#fbbf24}.err{color:#f87171}.muted{color:#9ca3af}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:6px 4px;text-align:left;font-size:14px}
  .balls{display:inline-flex;gap:6px;vertical-align:middle;flex-wrap:wrap}
  .ball{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;border:1px solid rgba(0,0,0,.25);color:#111;font-weight:800}
  .b-1{background:#facc15}.b-2{background:#60a5fa}.b-3{background:#ef4444}.b-4{background:#a78bfa}.b-5{background:#34d399}
  .tag{display:inline-block;padding:2px 6px;border-radius:999px;background:#334155;color:#cbd5e1;font-size:12px}
  .scale-0{background:#1f2937}.scale-1{background:#374151}.scale-2{background:#4b5563}.scale-3{background:#6b7280}.scale-4{background:#9ca3af}.scale-5{background:#e5e7eb;color:#111827}
  input[type=number]{background:#0b1220;border:1px solid #334155;color:#e5e7eb;border-radius:8px;padding:6px 8px;width:100px}
  button{background:#60a5fa;border:0;border-radius:8px;padding:8px 12px;font-weight:700;color:#0b1220;cursor:pointer}
</style>
<div class="wrap">
  <div class="card"><b>상태</b> <span id="status" class="muted">초기화 중…</span></div>

  <div class="card">
    <h3>① 예측_번호 — 5세트 번호 + 근거(%) 입력 테이블</h3>
    <div id="picks"></div>
  </div>

  <div class="card">
    <h3>② 이번주_전략카드 — 전략명/평균 Score/보상·위험비/추정 승률</h3>
    <div id="weekly"></div>
  </div>

  <div class="card">
    <h3>③ 최근10회_회차점프 — 최근 10회 표 + 회차 점프 입력 칸</h3>
    <div style="margin:6px 0">
      <label class="tag">회차 점프</label> <input id="jump" type="number" min="1" step="1" value="0"> 
      <button id="btnJump">이동</button>
    </div>
    <div id="recent"></div>
  </div>

  <div class="card">
    <h3>④ 구간별_번호_빈도 — 1~10, 11~20, 21~30, 31~40, 41~45 구간 및 합계(색상 스케일)</h3>
    <div id="intervals"></div>
  </div>

  <div class="card">
    <h3>⑤ 전략별_추천_상세 — 보수/균형/고위험 각 5개 Top 조합 표 + 지표 설명</h3>
    <div id="strategies"></div>
  </div>
</div>
<script>
const cls=n=>n<=10?'b-1':n<=20?'b-2':n<=30?'b-3':n<=40?'b-4':'b-5';
const ball=n=>`<span class="ball ${cls(n)}">${n}</span>`;
const balls=a=>`<span class="balls">`+a.map(ball).join('')+`</span>`;
const byId=id=>document.getElementById(id);
async function api(p){const r=await fetch(p,{cache:'no-store'});const t=await r.text();try{return JSON.parse(t)}catch(e){throw new Error(t||e)}}

let DATA=null;

function renderPicks(picks){
  let html='<table><thead><tr><th>#</th><th>조합</th><th>근거(%)</th></tr></thead><tbody>';
  picks.forEach((row,i)=>{
    const reasons = row.reasons.map(x=>`${x.n}:${x.pct}%`).join(', ');
    html+=`<tr><td>${i+1}</td><td>${balls(row.numbers)}</td><td>${reasons}</td></tr>`;
  });
  html+='</tbody></table>';
  byId('picks').innerHTML=html;
}

function renderWeekly(weekly){
  byId('weekly').innerHTML = `
    <div><span class="tag">전략</span> <b>${weekly.name}</b></div>
    <div style="margin-top:6px">${balls(weekly.set)}</div>
    <div style="margin-top:6px">평균 Score: <b>${weekly.avg_score}</b> / 보상·위험비(R/R): <b>${weekly.rr}</b> / 추정 승률: <b>${weekly.winrate}%</b></div>
  `;
}

function renderRecent(recent10){
  let html='<table><thead><tr><th>회차</th><th>날짜</th><th>번호</th><th>합</th><th>홀</th><th>고</th></tr></thead><tbody>';
  recent10.forEach(r=>{
    html+=`<tr><td>${r.round}</td><td>${r.date}</td><td>${balls(r.nums)}</td><td>${r.sum}</td><td>${r.odd}</td><td>${r.high}</td></tr>`;
  });
  html+='</tbody></table>';
  byId('recent').innerHTML=html;
}

function scaleClass(v, max){
  const s = max? Math.round((v/max)*5):0;
  return 'scale-'+Math.min(5,Math.max(0,s));
}

function renderIntervals(intervals){
  const groups = intervals.groups;
  const maxv = Math.max(...groups.flatMap(g=>g.items.map(x=>x.freq)));
  let html='';
  groups.forEach(g=>{
    html+=`<div style="margin:6px 0"><div><span class="tag">${g.range}</span> 합계: <b>${g.total}</b></div>`;
    html+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px">';
    g.items.forEach(it=>{
      html+=`<div class="ball ${cls(it.n)} ${scaleClass(it.freq,maxv)}" title="빈도:${it.freq}">${it.n}</div>`;
    });
    html+='</div></div>';
  });
  byId('intervals').innerHTML=html;
}

function renderStrategies(strats){
  let html='';
  strats.forEach(s=>{
    html+=`<div style="margin:10px 0"><div><b>${s.name}</b> <span class="muted">${s.note||''}</span></div>`;
    html+='<table><thead><tr><th>#</th><th>조합</th><th>Score</th><th>보상</th><th>위험</th></tr></thead><tbody>';
    s.combos.forEach((c,i)=>{
      html+=`<tr><td>${i+1}</td><td>${balls(c.numbers)}</td><td>${c.score}</td><td>${c.reward}</td><td>${c.risk}</td></tr>`;
    });
    html+='</tbody></table>';
    html+='<div class="muted" style="margin-top:4px">※ Score = 보상 / (1+위험), 보상=빈도 평균, 위험=편차+인접패널티(표시용 가늠치)</div>';
    html+='</div>';
  });
  byId('strategies').innerHTML=html;
}

async function loadAll(last=100){
  byId('status').textContent='로딩 중…';
  try{
    const j = await api('/api/analysis?last='+last);
    DATA=j;
    byId('status').textContent = j.count ? `OK: 최근 ${j.count}회 (최신 ${j.latest}회)` : '데모 데이터';
    renderPicks(j.picks);
    renderWeekly(j.weekly);
    renderRecent(j.recent10);
    renderIntervals(j.intervals);
    renderStrategies(j.strategies);
  }catch(e){
    byId('status').textContent='오류: '+e.message;
  }
}

document.getElementById('btnJump').onclick = ()=>{
  const v = parseInt(document.getElementById('jump').value||'0',10);
  if(!DATA){return;}
  // 단순 표시용: 최근10회 기준으로 v만큼 오프셋 이동(데모에서는 동일)
  const r = DATA.recent10;
  const slice = r.slice(v, v+10);
  renderRecent(slice.length? slice : r);
};

loadAll(120);
</script>
