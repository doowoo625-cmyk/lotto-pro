<!doctype html>
<meta charset="utf-8">
<title>로또 예측 — v3.0-final</title>
<style>
  body{margin:0;background:#0f172a;color:#0b1220;font-family:system-ui}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .card{background:#ffffff;border:1px solid #dbe3f0;border-radius:14px;padding:14px;margin-top:12px;box-shadow:0 4px 12px rgba(17,24,39,.06)}
  .muted{color:#64748b} .tag{display:inline-block;padding:2px 6px;border-radius:999px;background:#e2e8f0;color:#0b1220;font-size:12px}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #e5e7eb;padding:8px 6px;text-align:left;font-size:14px}
  .balls{display:inline-flex;gap:8px;vertical-align:middle;flex-wrap:wrap}
  .ball{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:50%;border:1px solid rgba(0,0,0,.25);color:#111;font-weight:800}
  .b-1{background:#facc15}.b-2{background:#60a5fa}.b-3{background:#ef4444}.b-4{background:#a78bfa}.b-5{background:#34d399}
  input[type=number], select{background:#f8fafc;border:1px solid #cbd5e1;color:#0b1220;border-radius:8px;padding:6px 8px}
  button{background:#0ea5e9;border:0;border-radius:8px;padding:10px 14px;font-weight:700;color:#fff;cursor:pointer}
  h3{margin:6px 0 10px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
</style>
<div class="wrap">
  <div class="card"><b>상태</b> <span id="status" class="muted">초기화 중…</span></div>

  <div class="card">
    <h3>① 예측 번호 뽑기</h3>
    <div class="row">
      <button id="btnPredict">예측 번호 뽑기 🔮</button>
      <span class="muted">5세트 자동 생성 · 근거(%) 표시</span>
    </div>
    <div id="picks" style="margin-top:8px"></div>
    <div id="pickReasons" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h3>② 이번 주 추천 전략</h3>
    <div id="weekly"></div>
  </div>

  <div class="card">
    <h3>③ 전략별 추천 (각 5세트)</h3>
    <div id="strategies"></div>
  </div>

  <div class="card">
    <h3>④ 최근 10회 결과 (조회 기능 포함)</h3>
    <div class="row" style="margin:6px 0">
      <label class="tag">조회 회차(기준)</label>
      <input id="queryRoundTxt" type="number" min="1" step="1" placeholder="회차 입력">
      <select id="queryRoundSel"></select>
      <button id="btnQuery">조회</button>
      <span class="muted">※ 기본값: 최신 회차 기준 10회</span>
    </div>
    <div id="recent"></div>
  </div>

  <div class="card">
    <h3>⑤ 회차 점프</h3>
    <div class="row" style="margin:6px 0">
      <label class="tag">이동 회차</label>
      <input id="jumpTxt" type="number" min="1" step="1" placeholder="회차 입력">
      <select id="jumpSel"></select>
      <button id="btnJump">이동</button>
    </div>
    <div id="jumpResult"></div>
  </div>

  <div class="card">
    <h3>⑥ 구간별 번호 빈도 <span class="muted">(조회 회차 수)</span></h3>
    <div class="row" style="margin:6px 0">
      <input id="rangeInput" type="number" min="10" max="2000" step="10" value="10">
      <select id="rangeSel"></select>
      <button id="btnRange">조회</button>
    </div>
    <div id="intervals"></div>
  </div>
</div>
<script>
const cls=n=>n<=10?'b-1':n<=20?'b-2':n<=30?'b-3':n<=40?'b-4':'b-5';
const ball=n=>`<span class="ball ${cls(n)}">${n}</span>`;
const balls=a=>`<span class="balls">`+a.map(ball).join('')+`</span>`;
const byId=id=>document.getElementById(id);
async function api(p){const r=await fetch(p,{cache:'no-store'});const t=await r.text();try{return JSON.parse(t)}catch(e){throw new Error(t||e)}}

let LATEST=0, DATA=null;

function renderPicks(picks){
  let html='<table><thead><tr><th>#</th><th>조합</th><th>근거(%)</th></tr></thead><tbody>';
  let firstReasons='';
  picks.forEach((row,i)=>{
    const reasons = row.reasons.map(x=>`${x.n}:${x.pct}%`).join(', ');
    html+=`<tr><td>${i+1}</td><td>${balls(row.numbers)}</td><td>${reasons}</td></tr>`;
    if(i===0){ firstReasons = reasons; }
  });
  html+='</tbody></table>';
  byId('picks').innerHTML=html;
  byId('pickReasons').textContent = '1세트 근거(%) — ' + firstReasons;
}

function renderWeekly(weekly){
  byId('weekly').innerHTML = `
    <div><span class="tag">추천 전략</span> <b>${weekly.name}</b></div>
    <div style="margin-top:6px">${balls(weekly.set)}</div>
    <div style="margin-top:6px">평균 Score: <b>${weekly.avg_score}</b> / 보상·위험비(R/R): <b>${weekly.rr}</b> / 추정 승률: <b>${weekly.winrate}%</b></div>
  `;
}

function renderRecent(recent10, targetEl){
  let html='<table><thead><tr><th>회차</th><th>날짜</th><th>번호</th><th>합</th><th>홀</th><th>고번호</th></tr></thead><tbody>';
  recent10.forEach(r=>{
    html+=`<tr><td>${r.round}</td><td>${r.date}</td><td>${balls(r.nums)}</td><td>${r.sum}</td><td>${r.odd}</td><td>${r.high}</td></tr>`;
  });
  html+='</tbody></table>';
  byId(targetEl).innerHTML=html;
}

function scaleStyle(v, max){
  const steps=[0,.2,.4,.6,.8,1.0];
  const ratio = max? v/max : 0;
  const i = steps.findIndex(s=>ratio<=s);
  const idx = i===-1?5:Math.max(0,i-1);
  const colors=['#f1f5f9','#e2e8f0','#cbd5e1','#94a3b8','#64748b','#475569'];
  return `background:${colors[idx]};color:${idx>=3?'#fff':'#0b1220'};`;
}

function renderIntervals(intervals){
  const groups = intervals.groups;
  const maxv = Math.max(...groups.flatMap(g=>g.items.map(x=>x.freq)));
  let html='';
  groups.forEach(g=>{
    html+=`<div style="margin:8px 0"><div><span class="tag">${g.range}</span> 합계: <b>${g.total}</b></div>`;
    html+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px">';
    g.items.forEach(it=>{
      html+=`<div class="ball ${cls(it.n)}" style="${scaleStyle(it.freq,maxv)}" title="빈도:${it.freq}">${it.n}</div>`;
    });
    html+='</div></div>';
  });
  byId('intervals').innerHTML=html;
}

function renderStrategies(strats){
  let html='';
  strats.forEach(s=>{
    html+=`<div style="margin:10px 0"><div><b>${s.name}</b> <span class="muted">${s.note||''}</span></div>`;
    html+='<table><thead><tr><th>#</th><th>조합</th><th>Score</th><th>보상</th><th>위험</th></tr></thead><tbody>';
    s.combos.forEach((c,i)=>{
      html+=`<tr><td>${i+1}</td><td>${balls(c.numbers)}</td><td>${c.score}</td><td>${c.reward}</td><td>${c.risk}</td></tr>`;
    });
    html+='</tbody></table>';
    html+='<div class="muted" style="margin-top:4px">※ Score = 보상 ÷ (1+위험), 보상=빈도 평균, 위험=편차+인접패널티(표시용)</div>';
    html+='</div>';
  });
  byId('strategies').innerHTML=html;
}

function fillDropdown(sel, latest){
  sel.innerHTML = '';
  for(let n=latest; n>=1; n--){
    const o=document.createElement('option'); o.value=n; o.textContent=n+'회'; sel.appendChild(o);
  }
}

async function loadAll(anchor=null, last=10){
  byId('status').textContent='로딩 중…';
  try{
    const url = anchor ? `/api/analysis?last=${last}&anchor=${anchor}` : `/api/analysis?last=${last}`;
    const j = await api(url);
    DATA=j; LATEST=j.latest;
    byId('status').textContent = j.count ? `OK: 기준 ${anchor||j.latest}회 / 최근 ${j.count}회` : '데모 데이터';

    // dropdowns
    fillDropdown(byId('queryRoundSel'), j.latest);
    fillDropdown(byId('jumpSel'), j.latest);
    const rangeSel = byId('rangeSel');
    rangeSel.innerHTML='';
    [10,20,30,40,50,80,100,120].forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent=v+'회'; rangeSel.appendChild(o);
    });
    // render sections
    renderPicks(j.picks);
    renderWeekly(j.weekly);
    renderStrategies(j.strategies);
    renderRecent(j.recent10, 'recent');
    renderIntervals(j.intervals);
  }catch(e){
    byId('status').textContent='오류: '+e.message;
  }
}

// handlers
byId('btnPredict').onclick = async ()=>{
  const anchor = DATA?.anchor || null;
  await loadAll(anchor, 10);
};

byId('btnQuery').onclick = async ()=>{
  const txt = parseInt(byId('queryRoundTxt').value||'0',10);
  const sel = parseInt(byId('queryRoundSel').value||'0',10);
  const anchor = txt>0 ? txt : (sel>0? sel : null);
  await loadAll(anchor, 10);
};

byId('btnJump').onclick = async ()=>{
  const txt = parseInt(byId('jumpTxt').value||'0',10);
  const sel = parseInt(byId('jumpSel').value||'0',10);
  const anchor = txt>0 ? txt : (sel>0? sel : null);
  const j = await api(`/api/analysis?last=10&anchor=${anchor||''}`);
  renderRecent(j.recent10, 'jumpResult');
  const odds = j.recent10.reduce((a,r)=>a+r.odd,0)/(j.recent10.length||1);
  const highs = j.recent10.reduce((a,r)=>a+r.high,0)/(j.recent10.length||1);
  const sum = j.recent10.reduce((a,r)=>a+r.sum,0)/(j.recent10.length||1);
  const note = document.createElement('div');
  note.className='muted'; note.style.marginTop='6px';
  note.textContent = `요약: 평균 합=${sum.toFixed(1)}, 평균 홀=${odds.toFixed(1)}, 평균 고번호=${highs.toFixed(1)}`;
  byId('jumpResult').appendChild(note);
};

byId('btnRange').onclick = async ()=>{
  const v1 = parseInt(byId('rangeInput').value||'10',10);
  const v2 = parseInt(byId('rangeSel').value||v1,10);
  const last = v1 || v2 || 10;
  const j = await api(`/api/analysis?last=${last}`);
  renderIntervals(j.intervals);
};

loadAll(null, 10);
</script>
