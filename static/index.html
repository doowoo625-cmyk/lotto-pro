<!doctype html>
<meta charset="utf-8">
<title>로또 예측 — Feature UI</title>
<style>
  body{margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui}
  .wrap{max-width:1080px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:#111827;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px}
  .ok{color:#34d399}.warn{color:#fbbf24}.err{color:#f87171}.muted{color:#9ca3af}
  .balls{display:inline-flex;gap:6px;vertical-align:middle;flex-wrap:wrap}
  .ball{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:50%;border:1px solid rgba(0,0,0,.25);color:#111;font-weight:800}
  .b-1{background:#facc15}.b-2{background:#60a5fa}.b-3{background:#ef4444}.b-4{background:#a78bfa}.b-5{background:#34d399}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:6px 4px;text-align:left}
</style>
<div class="wrap">
  <div class="card"><b>상태</b> <span id="status" class="muted">초기화 중…</span>
    <div style="margin-top:8px">
      <button id="retry">재시도</button>
      <a href="/diag" target="_blank"><button>diag</button></a>
      <a href="/api/probe" target="_blank"><button>probe</button></a>
      <a href="/api/stats?last=50" target="_blank"><button>stats</button></a>
    </div>
  </div>

  <div class="card">
    <h3>① 예측 번호 뽑기</h3>
    <div id="picks"></div>
    <small class="muted">번호는 최근 빈도 가중치로 샘플링. 5세트 제시.</small>
    <div style="margin-top:8px"><button id="btnPick">다시 뽑기</button></div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="card">
      <h3>② 이번 주 추천 전략 카드</h3>
      <div id="weeklyCard"></div>
    </div>
    <div class="card">
      <h3>③ 최근 결과 / 회차 점프</h3>
      <div id="recent"></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>④ 구간별 번호 빈도</h3>
    <div id="freq"></div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>⑤ 전략별 추천 (상세)</h3>
    <div id="strategies"></div>
  </div>
</div>
<script>
const cls=n=>n<=10?'b-1':n<=20?'b-2':n<=30?'b-3':n<=40?'b-4':'b-5';
const ball=n=>`<span class="ball ${cls(n)}">${n}</span>`;
const balls=a=>`<span class="balls">`+a.map(ball).join('')+`</span>`;
const byId=id=>document.getElementById(id);
const api=async p=>{const r=await fetch(p,{cache:'no-store'});const t=await r.text();try{return JSON.parse(t)}catch(e){throw new Error(t||e)}};

let FREQ=[], RECENT10=[], LATEST=0, COUNT=0;

function weightedPick(freq){
  const max=Math.max(...freq);
  const pool=[]; for(let n=1;n<=45;n++){const w=(freq[n]/(max||1)); const c=Math.max(1,Math.floor(w*100)); for(let i=0;i<c;i++) pool.push(n);}
  const s=new Set(); while(s.size<6) s.add(pool[Math.floor(Math.random()*pool.length)]);
  return Array.from(s).sort((a,b)=>a-b);
}

function renderPicks(){
  const el=byId('picks'); el.innerHTML='';
  for(let i=0;i<5;i++){ el.innerHTML += `<div style="margin:4px 0">${balls(weightedPick(FREQ))}</div>`; }
}

function renderRecent(){
  const el=byId('recent');
  if(!RECENT10.length){el.textContent='데이터 없음';return;}
  el.innerHTML = RECENT10.map(r=>`${r.round}회 (${r.date}) — ${balls(r.nums)} <span class="muted">합:${r.sum}, 홀:${r.odd}, 고:${r.high}</span>`).join('<br>');
}

function renderFreq(){
  const el=byId('freq');
  let html='<table><thead><tr><th>번호</th><th>빈도</th></tr></thead><tbody>';
  for(let n=1;n<=45;n++){ html+=`<tr><td>${ball(n)}</td><td>${FREQ[n]||0}</td></tr>`; }
  html+='</tbody></table>'; el.innerHTML=html;
}

function pickByStrategy(name){
  const p=weightedPick(FREQ);
  if(name==='보수형') return p;
  if(name==='고위험형'){
    // 상위빈도 비중을 줄이고 랜덤성 ↑
    const rnd=Array.from({length:6},()=>Math.floor(Math.random()*45)+1).sort((a,b)=>a-b);
    return Array.from(new Set(rnd)).slice(0,6).sort((a,b)=>a-b);
  }
  return p; // 균형형 = 기본
}

function renderWeeklyCard(){
  const options=['보수형','균형형','고위험형'];
  // 간단 점수: 상위 빈도 합이 크면 보수형, 다양성 크면 고위험형
  const topFreq = [...FREQ].map((v,i)=>({i,v})).slice(1).sort((a,b)=>b.v-a.v).slice(0,12);
  const diversity = new Set(RECENT10.flatMap(r=>r.nums)).size;
  let best = diversity>35 ? '보수형' : (diversity<28 ? '고위험형' : '균형형');
  const set = pickByStrategy(best);
  byId('weeklyCard').innerHTML = `
    <div><b>이번 주 추천 전략:</b> ${best}</div>
    <div style="margin-top:6px">${balls(set)}</div>
    <small class="muted">기준: 최근 다양성=${diversity}, 상위빈도 샘플=${topFreq.slice(0,5).map(x=>x.i).join(',')}</small>
  `;
}

function renderStrategies(){
  const names=['보수형','균형형','고위험형'];
  let html='';
  for(const name of names){
    const set=pickByStrategy(name);
    html+=`<div style="margin:6px 0"><b>${name}</b><div>${balls(set)}</div></div>`;
  }
  byId('strategies').innerHTML = html;
}

async function loadStats(n=50){
  byId('status').textContent='로딩 중…';
  try{
    const j = await api('/api/stats?last='+n);
    FREQ=j.freq; RECENT10=j.recent10; LATEST=j.latest; COUNT=j.count;
    byId('status').textContent = j.count ? `OK: 최근 ${j.count}회 (최신 ${LATEST}회)` : '데모 데이터';
    renderPicks(); renderRecent(); renderFreq(); renderWeeklyCard(); renderStrategies();
  }catch(e){
    byId('status').textContent='오류: '+e.message;
  }
}

byId('retry').onclick=()=>loadStats(50);
byId('btnPick').onclick=renderPicks;
loadStats(50);
</script>
