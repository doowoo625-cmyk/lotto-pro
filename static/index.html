<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¡œë˜ ì˜ˆì¸¡ â€” ì£¼ì°¨ë³„ ìë™ ìµœì‹ í™”</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; --ok:#34d399; --warn:#fbbf24; --bad:#f87171; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Noto Sans KR",Arial}
    header{padding:16px 12px;position:sticky;top:0;background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(15,23,42,.7),rgba(15,23,42,0));border-bottom:1px solid rgba(255,255,255,.06);z-index:5}
    h1{margin:0;font-size:20px}
    .container{max-width:1200px;margin:0 auto;padding:12px}
    .grid{display:grid;gap:12px}
    @media(min-width:980px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:14px}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:12px}
    .muted{color:var(--muted)}
    button{background:var(--accent);color:#0b1220;border:none;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .small{font-size:12px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:middle}
    th{text-align:left;color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .kpi .item{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);padding:10px;border-radius:10px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:18px;font-weight:800;margin-top:2px}
    .right{margin-left:auto}
    input[type=number],input[type=text]{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--text);border-radius:8px;padding:6px 8px}
    input[type=number]{width:90px} input[type=text]{width:140px}

    /* Lotto balls (ë™í–‰ë³µê¶Œ ìƒ‰ìƒ) */
    .balls{display:flex;gap:6px;flex-wrap:wrap}
    .ball{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;border:1px solid rgba(0,0,0,.2);text-shadow:0 1px 0 rgba(255,255,255,.4);}
    .b-1{background:#facc15;color:#111}      /* 1~10 ë…¸ë‘ */
    .b-2{background:#60a5fa;color:#111}      /* 11~20 íŒŒë‘ */
    .b-3{background:#ef4444;color:#111}      /* 21~30 ë¹¨ê°• */
    .b-4{background:#a78bfa;color:#111}      /* 31~40 ë³´ë¼ */
    .b-5{background:#34d399;color:#111}      /* 41~45 ì´ˆë¡ */
    .ball.bonus{background:#9ca3af;color:#111} /* ë³´ë„ˆìŠ¤: íšŒìƒ‰ */

    .sec-title{display:flex;align-items:center;gap:8px}
    .err{color:#f87171;font-size:13px;margin-top:6px}
    .hint{color:#9ca3af;font-size:12px;margin-top:2px}

    /* ì˜ˆì¸¡ê²°ê³¼ 2ë‹¨ ë ˆì´ì•„ì›ƒ */
    .predict-grid{display:grid;gap:12px}
    @media(min-width:980px){.predict-grid{grid-template-columns:1fr 1fr}}
    .predict-left > .card{margin-bottom:8px}

    /* ê·¸ë£¹ ë¹ˆë„ ì¹´ë“œ */
    .group-grid{display:grid;gap:8px}
    @media(min-width:980px){.group-grid{grid-template-columns:1fr 1fr}}

    /* ê·¸ë£¹ ê°•ì¡° ìƒ‰ (ê°ê¸° ë‹¤ë¥¸ ìƒìœ„2ìƒ‰ + ìµœí•˜ìœ„) */
    .group-top1{box-shadow:0 0 0 3px #16a34a55 inset, 0 0 0 1px #16a34a; background:linear-gradient(0deg, rgba(22,163,74,.08), rgba(22,163,74,.02));}
    .group-top2{box-shadow:0 0 0 3px #2563eb55 inset, 0 0 0 1px #2563eb; background:linear-gradient(0deg, rgba(37,99,235,.08), rgba(37,99,235,.02));}
    .group-low{box-shadow:0 0 0 3px #ef444455 inset, 0 0 0 1px #ef4444; background:linear-gradient(0deg, rgba(239,68,68,.08), rgba(239,68,68,.02));}

    .legend .chip{display:inline-block;border-radius:6px;padding:4px 8px;margin-right:6px;border:1px solid rgba(255,255,255,.1)}
    .chip.top1{background:rgba(22,163,74,.2)} .chip.top2{background:rgba(37,99,235,.2)} .chip.low{background:rgba(239,68,68,.2)}

    /* ìƒë‹¨ ì¶”ì²œ ì „ëµ ì¹´ë“œ */
    .hero{display:grid; gap:12px; margin-top:12px}
    @media(min-width:980px){.hero{grid-template-columns:1fr 1fr}}
    .hero .big{font-size:22px;font-weight:900}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="container row">
      <h1>ğŸ¯ ë¡œë˜ ì˜ˆì¸¡ â€” ì£¼ì°¨ë³„ ìë™ ìµœì‹ í™”</h1>
      <span class="pill">ìµœì‹  íšŒì°¨: <b id="latest">-</b></span>
      <span class="pill">ë°ì´í„°: <b id="dataStatus">ìµœê·¼ 200íšŒ</b></span>
      <button id="loadAll">ì „ì²´ ë°ì´í„° ë¡œë“œ(ë°±ê·¸ë¼ìš´ë“œ)</button>
      <span class="right pill small muted">ì „ì²´ ë°ì´í„°ëŠ” ë¶„ì„/ì˜ˆì¸¡ì—ë§Œ ì‚¬ìš© Â· í™”ë©´ì€ ìµœê·¼ 10íšŒë§Œ</span>
    </div>
    <div class="container hero">
      <div class="card" id="weeklyCard">
        <div class="small muted">ì´ë²ˆ ì£¼ ì¶”ì²œ ì „ëµ (Weekly Adaptive Pick)</div>
        <div class="big" id="weeklyName">-</div>
        <div id="weeklyWhy" class="small" style="margin-top:6px">ë°ì´í„°ê°€ ë¡œë”©ë˜ë©´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        <div class="kpi" style="margin-top:10px">
          <div class="item"><div class="label">í‰ê·  Score</div><div id="wScore" class="value">-</div></div>
          <div class="item"><div class="label">ë³´ìƒ/ìœ„í—˜ ë¹„</div><div id="wRR" class="value">-</div></div>
          <div class="item"><div class="label">ì¶”ì • ìŠ¹ë¥ </div><div id="wWin" class="value">-</div></div>
        </div>
      </div>
      <div class="card">
        <div class="small muted">ë²”ë¡€ (Legend)</div>
        <div class="legend" style="margin-top:6px">
          <span class="chip top1">ìµœê³  êµ¬ê°„ëŒ€ (Top1)</span>
          <span class="chip top2">ì°¨ìƒìœ„ (Top2)</span>
          <span class="chip low">ìµœì € êµ¬ê°„ëŒ€ (Lowest)</span>
        </div>
        <div class="small muted" style="margin-top:6px">êµ¬ê°„ë³„ ë²ˆí˜¸ ë¹ˆë„ ì¹´ë“œì— ê°•ì¡°ìƒ‰ì´ ì ìš©ë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- â‘  ì˜ˆì¸¡ ë²ˆí˜¸ ë½‘ê¸° -->
    <section class="card">
      <div class="sec-title">
        <h2>ğŸ¤– ì˜ˆì¸¡ ë²ˆí˜¸ ë½‘ê¸°</h2>
        <span class="muted small">(ë°ì´í„° ê¸°ë°˜ ê°€ì¤‘ì¹˜ Â· 5ì„¸íŠ¸, 6ê°œ+ë³´ë„ˆìŠ¤)</span>
        <span class="right row small">
          <label>ìµœê·¼ ë°˜ì˜ ë²”ìœ„(NíšŒ): <input id="predN" type="number" value="30" min="10" max="100" step="5"></label>
          <label>ë¹ˆë„/ê³µì¶œí˜„ ê°€ì¤‘(0~1): <input id="alpha" type="number" value="0.6" min="0" max="1" step="0.1"></label>
          <button id="predictBtn">ì˜ˆì¸¡ ë²ˆí˜¸ ë½‘ê¸°</button>
        </span>
      </div>
      <div class="predict-grid" style="margin-top:8px">
        <div class="predict-left" id="predBalls"></div>
        <div class="predict-right">
          <div class="card">
            <b>ê·¼ê±° ë° í™•ë¥ (%) (Rationale & Probability)</b>
            <div class="small muted" style="margin-top:6px">* ê° ì„¸íŠ¸ì˜ ë¹ˆë„ ê¸°ì—¬, ê³µì¶œí˜„ ê¸°ì—¬, êµ¬ì¡° ì í•©ë„, ì¢…í•© ì ìˆ˜(0~100)</div>
            <div id="predTable" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
      <div id="predErr" class="err" style="display:none"></div>
    </section>

    <!-- â‘¡ ê° ì „ëµë³„ ìµœìƒìœ„ 1ì„¸íŠ¸ + ì´ë²ˆ ì£¼ ì¶”ì²œ ì¹´ë“œ -->
    <section class="card" id="topSetPerStrategy">
      <div class="sec-title"><h2>ğŸ”¥ ì „ëµë³„ ìµœìƒìœ„ 1ì„¸íŠ¸ (Top Set per Strategy)</h2><span class="muted small">ì˜ˆì¸¡ ì•„ë˜ ìë™ ë°˜ì˜</span></div>
      <div id="topSetsRow" class="grid grid-3"></div>
    </section>
  </div>

  <div class="container grid grid-2">

    <!-- â‘¢ ìµœê·¼ ê²°ê³¼ / íšŒì°¨ì í”„ -->
    <section class="card">
      <h2>ğŸ“‹ ìµœê·¼ 10íšŒ ê²°ê³¼ (Recent 10 Draws)</h2>
      <div class="row small">
        <label>í‘œì‹œ ê°œìˆ˜ <input type="number" id="showCount" value="10" min="5" max="20"></label>
        <button id="refreshTable">í‘œ ê°±ì‹ </button>
      </div>
      <div id="recentTable"></div>
      <div id="recentErr" class="err" style="display:none"></div>
    </section>

    <section class="card">
      <h2>ğŸ” íšŒì°¨ ì í”„ (Round Jump)</h2>
      <div class="row small">
        <input type="text" id="roundJump" list="roundsList" placeholder="íšŒì°¨ ë²ˆí˜¸ ì…ë ¥/ì„ íƒ">
        <datalist id="roundsList"></datalist>
        <button id="jumpBtn">ì´ë™</button>
      </div>
      <div id="jumpResult" class="small muted">íšŒì°¨ë¥¼ ì„ íƒí•˜ë©´ ì•„ë˜ì— ë²ˆí˜¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div id="jumpErr" class="err" style="display:none"></div>
    </section>

    <!-- â‘£ êµ¬ê°„ë³„ ë²ˆí˜¸ ë¹ˆë„ -->
    <section class="card" style="grid-column:1/-1">
      <div class="sec-title"><h2>ğŸŸ¡ğŸ”µğŸ”´ğŸŸ£ğŸŸ¢ êµ¬ê°„ë³„ ë²ˆí˜¸ ë¹ˆë„(ì˜¤ë¦„ì°¨ìˆœ)</h2><span class="muted small">(1~10 / 11~20 / 21~30 / 31~40 / 41~45)</span></div>
      <div class="group-grid" id="groupFreqWrap"></div>
      <div id="groupErr" class="err" style="display:none"></div>
    </section>

    <!-- â‘¤ ì „ëµë³„ ì¶”ì²œ (ìƒì„¸) -->
    <section class="card" style="grid-column:1/-1">
      <div class="sec-title"><h2>ğŸ¯ ì „ëµë³„ ì¶”ì²œ (Adaptive ìë™ë¶„ì„)</h2></div>
      <div class="small muted">ì „ëµ ì´ë¦„/íŠ¹ì§•/ëŒ€ìƒì€ í•œê¸€(ì˜ë¬¸) ë³‘ê¸°</div>

      <div id="strategyDesc" style="margin-top:8px">
        <table>
          <thead><tr><th>ì „ëµ (Strategy)</th><th>íŠ¹ì§• (Traits)</th><th>ëŒ€ìƒ (For)</th></tr></thead>
          <tbody>
            <tr><td><b>ë³´ìˆ˜í˜• (Conservative)</b></td><td>ìì£¼ ë“±ì¥ ë²ˆí˜¸ ìœ„ì£¼, ë³€ë™ì„± ë‚®ìŒ</td><td>ê¾¸ì¤€íˆ ì°¸ì—¬í•˜ëŠ” ì‚¬ìš©ì</td></tr>
            <tr><td><b>ê· í˜•í˜• (Balanced)</b></td><td>ë¹ˆë„Â·ê³µì¶œí˜„Â·íŒ¨í„´ì„ ê· í˜• ë°˜ì˜</td><td>í‰ê· ì /ì•ˆì •+ê¸°íšŒ ì„ í˜¸ì</td></tr>
            <tr><td><b>ê³ ìœ„í—˜í˜• (High-Risk)</b></td><td>ëœ ë‚˜ì˜¨ ë²ˆí˜¸/í¬ì†Œ íŒ¨í„´ ê°•ì¡°</td><td>ë‹¨ê¸° ê³ ìˆ˜ìµ ë…¸ë¦¬ëŠ” ì‚¬ìš©ì</td></tr>
          </tbody>
        </table>
      </div>

      <div style="margin-top:10px">
        <table>
          <thead><tr><th>ì§€í‘œ (Metric)</th><th>ì„¤ëª… (Meaning)</th></tr></thead>
          <tbody>
            <tr><td><b>ìœ„í—˜ (Risk)</b></td><td>í•©ê³„Â·í™€ì§Â·ê³ ë²ˆí˜¸ êµ¬ì¡°ê°€ ì¼ë°˜ íŒ¨í„´ì—ì„œ ë²—ì–´ë‚ ìˆ˜ë¡ ìƒìŠ¹</td></tr>
            <tr><td><b>ë³´ìƒ (Reward)</b></td><td>ìµœê·¼ ëœ ë“±ì¥í•œ ë²ˆí˜¸ë¥¼ í¬í•¨í• ìˆ˜ë¡ ìƒìŠ¹</td></tr>
            <tr><td><b>ì ìˆ˜ (Score)</b></td><td>ë³´ìƒ Ã· (ìœ„í—˜ + Îµ) â€” ìœ„í—˜ ëŒ€ë¹„ íš¨ìœ¨</td></tr>
            <tr><td><b>ìŠ¹ë¥  (Win Rate, ì¶”ì •)</b></td><td>ì‹œë®¬ë ˆì´ì…˜ì—ì„œ ìƒìœ„ ì ìˆ˜ ê¸°ì¤€ì„ ì¶©ì¡±í•œ ë¹„ìœ¨</td></tr>
          </tbody>
        </table>
        <div class="small muted" style="margin-top:6px">â€» ìŠ¹ë¥ ì€ ë‚´ë¶€ ì‹œë®¬ë ˆì´ì…˜ ê¸°ë°˜ ì¶”ì •ì¹˜ë¡œ, ì‹¤ì œ ë‹¹ì²¨ í™•ë¥ ì„ ì˜ë¯¸í•˜ì§€ ì•ŠìŒ.</div>
      </div>

      <div class="grid grid-3" style="margin-top:12px">
        <div class="card"><b>ë³´ìˆ˜í˜• ìŠ¹ë¥  (Conservative)</b><canvas id="winC" height="150"></canvas></div>
        <div class="card"><b>ê· í˜•í˜• ìŠ¹ë¥  (Balanced)</b><canvas id="winB" height="150"></canvas></div>
        <div class="card"><b>ê³ ìœ„í—˜í˜• ìŠ¹ë¥  (High-Risk)</b><canvas id="winH" height="150"></canvas></div>
      </div>

      <div id="recs" class="grid grid-3" style="margin-top:12px"></div>

      <div class="kpi" style="margin-top:8px">
        <div class="item"><div class="label">Adaptive ì „ëµ</div><div id="asName" class="value">-</div></div>
        <div class="item"><div class="label">í‰ê·  Score</div><div id="asScore" class="value">-</div></div>
        <div class="item"><div class="label">ë³´ìƒ/ìœ„í—˜ ë¹„</div><div id="asRR" class="value">-</div></div>
      </div>
      <div id="recsErr" class="err" style="display:none"></div>
    </section>

  </div>

  <script>
    // ===== ê³µí†µ ìœ í‹¸ =====
    const byId = (id)=>document.getElementById(id);
    const api = async (p)=>{ const r = await fetch(p, {cache:'no-store'}); if(!r.ok) throw new Error(await r.text()); return r.json(); };

    // vis-network lazy loader
    let _visReady = null;
    function ensureVis(){
      if (window.vis && window.vis.Network) return Promise.resolve();
      if (_visReady) return _visReady;
      _visReady = new Promise((resolve,reject)=>{
        function done(){ (window.vis && window.vis.Network) ? resolve() : reject(new Error('vis-network ë¡œë“œ ì‹¤íŒ¨')); }
        const s1 = document.createElement('script');
        s1.src = 'https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.6/vis-network.min.js';
        s1.onload = () => setTimeout(()=> done(), 0);
        s1.onerror = () => {
          const s2 = document.createElement('script');
          s2.src = 'https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js';
          s2.onload = () => setTimeout(()=> done(), 0);
          s2.onerror = () => reject(new Error('vis-network CDN ì°¨ë‹¨'));
          document.head.appendChild(s2);
        };
        document.head.appendChild(s1);
        const l = document.createElement('link'); l.rel='stylesheet';
        l.href='https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.6/vis-network.min.css';
        document.head.appendChild(l);
      });
      return _visReady;
    }

    function ballClass(n){
      if(n>=1 && n<=10) return 'b-1';
      if(n>=11 && n<=20) return 'b-2';
      if(n>=21 && n<=30) return 'b-3';
      if(n>=31 && n<=40) return 'b-4';
      return 'b-5'; // 41~45
    }
    function ballsHtml(nums, includeBonus=false, bonus=null){
      const a = nums.map(n=>`<span class="ball ${ballClass(n)}">${n}</span>`).join('');
      const b = includeBonus && bonus ? `<span class="ball bonus">${bonus}</span>` : '';
      return `<div class="balls">${a}${b}</div>`;
    }
    function renderTable(el, rows, headers){
      if(!rows || !rows.length){ el.innerHTML = '<div class="muted small">ë°ì´í„° ì—†ìŒ</div>'; return; }
      el.innerHTML = '<table><thead><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>' +
        rows.map(r=>'<tr>' + headers.map(h=>`<td>${r[h] ?? ''}</td>`).join('') + '</tr>').join('') + '</tbody></table>';
    }

    // ===== ë¶„ì„ í•¨ìˆ˜ =====
    function buildCoMap(rows){
      const m = new Map();
      rows.forEach(r=>{
        const a = r.nums.slice().sort((x,y)=>x-y);
        for(let i=0;i<a.length;i++){ for(let j=i+1;j<a.length;j++){ const k=a[i]+','+a[j]; m.set(k,(m.get(k)||0)+1); } }
      });
      return m;
    }
    function frequency(rows){ const f = Array(46).fill(0); rows.forEach(r=>r.nums.forEach(n=>f[n]++)); return f; }
    function computeFeatures(rows){
      return rows.map(r=>{
        const sum = r.nums.reduce((a,b)=>a+b,0);
        const odd = r.nums.filter(n=>n%2===1).length;
        const high = r.nums.filter(n=>n>23).length;
        const arr = r.nums.slice().sort((a,b)=>a-b);
        let consec=0; for(let i=1;i<arr.length;i++){ if(arr[i]===arr[i-1]+1) consec++; }
        return {...r, sum, odd, even:6-odd, high, low:6-high, consec};
      });
    }

    // ===== ë„¤íŠ¸ì›Œí¬ (í° ê³µ + ë¼ë²¨/íˆ´íŒ) =====
    function nodeColor(n){
      if(n>=1 && n<=10) return '#facc15';
      if(n>=11 && n<=20) return '#60a5fa';
      if(n>=21 && n<=30) return '#ef4444';
      if(n>=31 && n<=40) return '#a78bfa';
      return '#34d399';
    }
    async function drawNetwork(map, topK){
      await ensureVis();
      const arr = Array.from(map.entries()).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v).slice(0, topK);
      const counts = {}; arr.forEach(e=>{ const [a,b]=e.k.split(',').map(Number); counts[a]=(counts[a]||0)+e.v; counts[b]=(counts[b]||0)+e.v; });
      const nodes = new Set(); arr.forEach(e=>e.k.split(',').forEach(x=>nodes.add(+x)));
      const ndata = Array.from(nodes).map(n=>({
        id:n, label:String(n),
        color:{ background: nodeColor(n), border: 'rgba(0,0,0,0.55)', highlight:{background: nodeColor(n), border:'#000'} },
        shape:'circle', size: 40 + Math.min(30,(counts[n]||1)*1.2),
        font:{color:'#111', size:20, bold:true, vadjust:1},
        title:`ë²ˆí˜¸ ${n} Â· ì—°ê²°í•© ${(counts[n]||0)}íšŒ`
      }));
      const edata = arr.map(e=>{ const [a,b]=e.k.split(',').map(Number); return {from:a,to:b,value:e.v,width:1+e.v, color:{opacity:.6}, title:`${a}â€“${b} : ${e.v}íšŒ`}; });
      const data = { nodes:new vis.DataSet(ndata), edges:new vis.DataSet(edata) };
      const options = {
        nodes:{ shape:'circle', borderWidth:2 },
        edges:{ smooth:true },
        physics:{ solver:'forceAtlas2Based', stabilization:{iterations:200} },
        interaction:{ hover:true, tooltipDelay:80 }
      };
      new vis.Network(byId('network'), data, options);
    }

    // ===== ì¶”ì²œ ë¡œì§ & ì°¨íŠ¸ =====
    function pickWeighted(freq, strategy){
      const maxf = Math.max(...freq);
      const pool = [];
      for(let n=1;n<=45;n++){
        const base = (freq[n]/maxf)||0.0001;
        let w = base; if (strategy==='conservative') w=Math.pow(base,.7); else if (strategy==='high_risk') w=Math.pow(base,1.6);
        const count = Math.max(1, Math.floor(w*100)); for(let i=0;i<count;i++) pool.push(n);
      }
      const set=new Set(); while(set.size<6) set.add(pool[Math.floor(Math.random()*pool.length)]);
      return Array.from(set).sort((a,b)=>a-b);
    }
    function scoreCombo(nums, freq, centers={sum:145, odd:3, high:3}){
      const s = nums.reduce((a,b)=>a+b,0);
      const odd = nums.filter(n=>n%2===1).length;
      const high = nums.filter(n=>n>23).length;
      const risk = Math.abs(s-centers.sum)/25 + Math.abs(odd-centers.odd)/3 + Math.abs(high-centers.high)/3;
      const maxf = Math.max(...freq);
      const reward = nums.reduce((acc,n)=> acc + (maxf - (freq[n]||0))/maxf, 0);
      const score = reward/(risk+1e-3);
      return {risk,reward,score,sum:s,odd,high};
    }
    function recommendBulk(freq, opts){
      const {strategy,trials,sumMin,sumMax,oddMin,oddMax,highMin,highMax} = opts;
      const arr=[]; const seen=new Set();
      const allScores = [];
      for(let i=0;i<trials;i++){
        const nums = pickWeighted(freq, strategy);
        const k = nums.join(','); if (seen.has(k)) continue; seen.add(k);
        const m = scoreCombo(nums,freq);
        allScores.push(m.score);
        if (m.sum>=sumMin && m.sum<=sumMax && m.odd>=oddMin && m.odd<=oddMax && m.high>=highMin && m.high<=highMax){ arr.push({nums,...m}); }
      }
      arr.sort((a,b)=>b.score-a.score);
      return {top:arr.slice(0,20), scores: allScores};
    }
    function chartWinRate(canvasId, rate){
      const ctx = byId(canvasId).getContext('2d');
      if (ctx._chart) { ctx._chart.destroy(); }
      ctx._chart = new Chart(ctx, {
        type:'doughnut',
        data:{ labels:['ì¶”ì • ìŠ¹ë¥ ','ê¸°íƒ€'], datasets:[{ data:[Math.round(rate*1000)/10, 100 - Math.round(rate*1000)/10] }]},
        options:{ responsive:true, plugins:{ legend:{display:false}, tooltip:{enabled:true} }, cutout:'60%' }
      });
    }

    // ===== ì˜ˆì¸¡(5ì„¸íŠ¸ + ê·¼ê±°%) =====
    function normalize(arr){
      const max = Math.max(...arr.slice(1)); const min = Math.min(...arr.slice(1));
      return arr.map((v,i)=> i===0?0 : (max===min? 1 : (v-min)/(max-min)));
    }
    function buildCoMapRecent(rows, N){
      const co = new Map();
      const recent = rows.slice(-N);
      recent.forEach(r=>{
        const a = r.nums.slice().sort((x,y)=>x-y);
        for(let i=0;i<a.length;i++){ for(let j=i+1;j<a.length;j++){ const k=a[i]+','+a[j]; co.set(k,(co.get(k)||0)+1); } }
      });
      return co;
    }
    function predictSets(rows, freq, coMap, N=30, alpha=0.6, sets=5){
      const recent = rows.slice(-N);
      const fnorm = normalize(freq);
      const co = Array(46).fill(0);
      recent.forEach(r=>{
        const a = r.nums.slice().sort((x,y)=>x-y);
        for(let i=0;i<a.length;i++){ for(let j=i+1;j<a.length;j++){ const k=a[i]+','+a[j]; const v=coMap.get(k)||0; co[a[i]] += v; co[a[j]] += v; } }
      });
      const cnorm = normalize(co);
      const weight = n => alpha * fnorm[n] + (1-alpha) * cnorm[n] + 1e-6;

      const out=[]; const used=new Set();
      for(let s=0;s<sets;s++){
        const pool=[];
        for(let n=1;n<=45;n++){
          const w = weight(n);
          const count = Math.max(1, Math.floor(w*100));
          for(let i=0;i<count;i++) pool.push(n);
        }
        for(const u of used){ const idx = pool.indexOf(u); if(idx>=0) pool.splice(idx,1); }
        const pick=new Set(); while(pick.size<6) pick.add(pool[Math.floor(Math.random()*pool.length)]);
        const nums = Array.from(pick).sort((a,b)=>a-b);
        nums.forEach(n=>used.add(n));

        let bestB=null, bestV=-1;
        for(let b=1;b<=45;b++){
          if(nums.includes(b)) continue;
          let v=0;
          for(const n of nums){ v += (coMap.get(Math.min(n,b)+','+Math.max(n,b))||0); }
          if(v>bestV){ bestV=v; bestB=b; }
        }
        const bonus = bestB || 1+Math.floor(Math.random()*45);

        const sum = nums.reduce((a,b)=>a+b,0);
        const odd = nums.filter(n=>n%2===1).length;
        const high = nums.filter(n=>n>23).length;
        const fit = 100 - (Math.min(Math.abs(sum-145),25)/25*100*0.4 + Math.min(Math.abs(odd-3),3)/3*100*0.3 + Math.min(Math.abs(high-3),3)/3*100*0.3);
        const freqPct = (nums.reduce((acc,n)=>acc+fnorm[n],0)/6)*100;
        const coPct = (nums.reduce((acc,n)=>acc+cnorm[n],0)/6)*100;
        const rationale = {
          freq: Math.round(freqPct),
          co: Math.round(coPct),
          fit: Math.round(fit),
          overall: Math.round((alpha*freqPct + (1-alpha)*coPct)*0.6 + fit*0.4)
        };
        out.push({nums, bonus, rationale});
      }
      return out.sort((a,b)=>b.rationale.overall - a.rationale.overall);
    }

    // ===== ìƒíƒœ =====
    let LATEST=null, ALL=[], BASE=[], FREQ=[];

    // ===== í‘œ & ê·¸ë£¹ ë¹ˆë„ =====
    function renderGroupFreq(){
      try{
        const wrap = byId('groupFreqWrap'); wrap.innerHTML='';
        const groups = [
          {name:'1~10', from:1,to:10},
          {name:'11~20', from:11,to:20},
          {name:'21~30', from:21,to:30},
          {name:'31~40', from:31,to:40},
          {name:'41~45', from:41,to:45},
        ];
        const totals = groups.map(g=>{
          let sum=0; for(let n=g.from;n<=g.to;n++) sum += (FREQ[n]||0);
          return sum;
        });
        const idxs=[0,1,2,3,4];
        idxs.sort((a,b)=>totals[b]-totals[a]);
        const top1=idxs[0], top2=idxs[1], low=idxs[4];

        groups.forEach((g,gi)=>{
          const rows = [];
          for(let n=g.from;n<=g.to;n++){
            rows.push({ë²ˆí˜¸: `<span class="ball ${ballClass(n)}">${n}</span>`, ë¹ˆë„: FREQ[n]||0});
          }
          const card = document.createElement('div');
          card.className='card';
          if (gi===top1) card.classList.add('group-top1');
          else if (gi===top2) card.classList.add('group-top2');
          else if (gi===low) card.classList.add('group-low');
          card.innerHTML = `<b>${g.name}</b><div id="g-${g.from}"></div><div class="small muted" style="margin-top:6px">êµ¬ê°„ í•©ê³„: ${totals[gi]}</div>`;
          wrap.appendChild(card);
          renderTable(card.querySelector('#g-'+g.from), rows, ['ë²ˆí˜¸','ë¹ˆë„']);
        });
        byId('groupErr').style.display='none';
      }catch(e){ byId('groupErr').style.display='block'; byId('groupErr').textContent='êµ¬ê°„ ë¹ˆë„ í‘œì‹œ ì˜¤ë¥˜: '+e.message; }
    }

    function renderRecentTable(){
      try{
        const k = parseInt(byId('showCount').value,10) || 10;
        const src = (ALL.length ? ALL : BASE);
        const rows = src.slice(-k).reverse().map(r=>({
          'íšŒì°¨': r.round,
          'ì¶”ì²¨ì¼': r.date,
          'ë‹¹ì²¨ë²ˆí˜¸': ballsHtml(r.nums),
          'í•©ê³„': r.sum, 'í™€ìˆ˜': r.odd, 'ê³ ë²ˆí˜¸': r.high
        }));
        renderTable(byId('recentTable'), rows, ['íšŒì°¨','ì¶”ì²¨ì¼','ë‹¹ì²¨ë²ˆí˜¸','í•©ê³„','í™€ìˆ˜','ê³ ë²ˆí˜¸']);
      }catch(e){ byId('recentErr').style.display='block'; byId('recentErr').textContent='ìµœê·¼ ê²°ê³¼ í‘œì‹œ ì˜¤ë¥˜: '+e.message; }
    }
    function populateRoundList(maxRound){
      const dl = byId('roundsList'); dl.innerHTML = '';
      const start = Math.max(1, maxRound - 499);
      for(let rn=maxRound; rn>=start; rn--){
        const opt = document.createElement('option'); opt.value = rn; dl.appendChild(opt);
      }
    }
    function jumpToRound(){
      try{
        const rn = parseInt(byId('roundJump').value,10);
        if (!rn) return;
        const find = (ALL.length ? ALL : BASE).find(x=>x.round===rn);
        if (!find){ byId('jumpErr').style.display='block'; byId('jumpErr').textContent='í•´ë‹¹ íšŒì°¨ê°€ í˜„ì¬ ë©”ëª¨ë¦¬ì— ì—†ìŒ(ë°°ê²½ ë¡œë”© í•„ìš”)'; return; }
        byId('jumpErr').style.display='none';
        byId('jumpResult').innerHTML = `íšŒì°¨ <b>${find.round}</b> â€” ì¶”ì²¨ì¼ ${find.date} â€” ë²ˆí˜¸ ${ballsHtml(find.nums)}`;
      }catch(e){ byId('jumpErr').style.display='block'; byId('jumpErr').textContent='íšŒì°¨ ì í”„ ì˜¤ë¥˜: '+e.message; }
    }

    function runRecs(){
      try{
        const trials = 30000, sumMin=120, sumMax=170, oddMin=2, oddMax=4, highMin=2, highMax=4;
        const strategies=['conservative','balanced','high_risk'];
        const recWrap = byId('recs'); recWrap.innerHTML='';
        const recStats={}, winRates={}; let allScorePool=[];
        for(const s of strategies){
          const {top, scores} = recommendBulk(FREQ,{strategy:s,trials,sumMin,sumMax,oddMin,oddMax,highMin,highMax});
          recStats[s]=top; allScorePool = allScorePool.concat(scores);
        }
        allScorePool.sort((a,b)=>a-b); const pIdx = Math.floor(allScorePool.length*0.75); const thresh = allScorePool[pIdx] || 0;
        for(const s of strategies){
          const arr = recStats[s];
          const rate = (arr.filter(o=>o.score>=thresh).length) / Math.max(1, arr.length);
          winRates[s]=rate;
          const box=document.createElement('div'); box.className='card';
          box.innerHTML=`<b>${s.toUpperCase()}</b><div id="t-${s}"></div>`; recWrap.appendChild(box);
          if (arr.length){
            const rows = arr.slice(0,5).map(o=>({ì¡°í•©:ballsHtml(o.nums),Risk:o.risk.toFixed(3),Reward:o.reward.toFixed(3),Score:o.score.toFixed(3)}));
            renderTable(box.querySelector(`#t-${s}`), rows, ['ì¡°í•©','Risk','Reward','Score']);
          }else{
            box.querySelector(`#t-${s}`).innerHTML = "<div class='muted small'>ì¶”ì²œ ì—†ìŒ</div>";
          }
        }
        const best = (function(stats){
          const list = Object.entries(stats).map(([name,arr])=>{
            if (!arr.length) return {name, meanScore:-1, rr:-1, meanRisk:999};
            const ms = arr.reduce((a,b)=>a+b.score,0)/arr.length;
            const mr = arr.reduce((a,b)=>a+b.risk,0)/arr.length;
            const mw = arr.reduce((a,b)=>a+b.reward,0)/arr.length;
            return {name, meanScore:ms, rr: mw/(mr+1e-3), meanRisk:mr, win: winRates[name]||0};
          });
          list.sort((a,b)=> b.meanScore-a.meanScore || b.rr-a.rr || a.meanRisk-b.meanRisk);
          return list[0];
        })(recStats);

        byId('asName').textContent = best?.name?.toUpperCase() || '-';
        byId('asScore').textContent = best?.meanScore>0 ? best.meanScore.toFixed(3) : '-';
        byId('asRR').textContent = best?.rr>0 ? best.rr.toFixed(3) : '-';

        chartWinRate('winC', winRates['conservative']||0);
        chartWinRate('winB', winRates['balanced']||0);
        chartWinRate('winH', winRates['high_risk']||0);

        byId('weeklyName').textContent = (best?.name ? (best.name==='balanced'?'ê· í˜•í˜• (Balanced)':best.name==='conservative'?'ë³´ìˆ˜í˜• (Conservative)':'ê³ ìœ„í—˜í˜• (High-Risk)') : '-');
        byId('weeklyWhy').textContent = best?.name ? `í‰ê·  Scoreì™€ ë³´ìƒ/ìœ„í—˜ ë¹„ ê¸°ì¤€ìœ¼ë¡œ ì´ë²ˆ ì£¼ ê°€ì¥ íš¨ìœ¨ì ì¸ ì „ëµì…ë‹ˆë‹¤.` : 'ë°ì´í„° ë¶€ì¡±';
        byId('wScore').textContent = best?.meanScore>0 ? best.meanScore.toFixed(3) : '-';
        byId('wRR').textContent = best?.rr>0 ? best.rr.toFixed(3) : '-';
        byId('wWin').textContent = (best?.win>0 ? Math.round(best.win*1000)/10 + '%' : '-');

        const cont = byId('topSetsRow'); cont.innerHTML='';
        const mapping = {conservative:'ë³´ìˆ˜í˜• (Conservative)', balanced:'ê· í˜•í˜• (Balanced)', high_risk:'ê³ ìœ„í—˜í˜• (High-Risk)'};
        for (const s of strategies){
          const card = document.createElement('div'); card.className='card';
          const first = (recStats[s]||[])[0];
          if (first){
            card.innerHTML = `<b>${mapping[s]}</b><div style="margin-top:6px">${ballsHtml(first.nums)}</div>
              <div class="small muted" style="margin-top:6px">Risk ${first.risk.toFixed(3)} Â· Reward ${first.reward.toFixed(3)} Â· Score ${first.score.toFixed(3)}</div>`;
          }else{
            card.innerHTML = `<b>${mapping[s]}</b><div class="small muted" style="margin-top:6px">ì¶”ì²œ ì—†ìŒ</div>`;
          }
          cont.appendChild(card);
        }
      }catch(e){ byId('recsErr').style.display='block'; byId('recsErr').textContent='ì¶”ì²œ ì˜¤ë¥˜: '+e.message; }
    }

    // ===== ì˜ˆì¸¡ =====
    function runPredict(){
      try{
        const N = parseInt(byId('predN').value,10);
        const alpha = parseFloat(byId('alpha').value);
        const src = (ALL.length ? ALL : BASE);
        const coMap = (function(rows,N){ const m=new Map(); rows.slice(-N).forEach(r=>{ const a=r.nums.slice().sort((x,y)=>x-y); for(let i=0;i<a.length;i++){ for(let j=i+1;j<a.length;j++){ const k=a[i]+','+a[j]; m.set(k,(m.get(k)||0)+1); } } }); return m; })(src,N);
        const sets = (function(rows, freq, coMap, N, alpha, sets){
          const recent = rows.slice(-N);
          const fnorm = (function(arr){ const max=Math.max(...arr.slice(1)), min=Math.min(...arr.slice(1)); return arr.map((v,i)=> i===0?0 : (max===min? 1 : (v-min)/(max-min))); })(freq);
          const co = Array(46).fill(0);
          recent.forEach(r=>{ const a=r.nums.slice().sort((x,y)=>x-y); for(let i=0;i<a.length;i++){ for(let j=i+1;j<a.length;j++){ const k=a[i]+','+a[j]; const v=coMap.get(k)||0; co[a[i]] += v; co[a[j]] += v; } } });
          const cnorm = (function(arr){ const max=Math.max(...arr.slice(1)), min=Math.min(...arr.slice(1)); return arr.map((v,i)=> i===0?0 : (max===min? 1 : (v-min)/(max-min))); })(co);
          const weight = n => alpha * fnorm[n] + (1-alpha) * cnorm[n] + 1e-6;
          const out=[]; const used=new Set();
          for(let s=0;s<sets;s++){
            const pool=[];
            for(let n=1;n<=45;n++){ const w=weight(n); const count=Math.max(1, Math.floor(w*100)); for(let i=0;i<count;i++) pool.push(n); }
            for(const u of used){ const idx = pool.indexOf(u); if(idx>=0) pool.splice(idx,1); }
            const pick=new Set(); while(pick.size<6) pick.add(pool[Math.floor(Math.random()*pool.length)]);
            const nums = Array.from(pick).sort((a,b)=>a-b); nums.forEach(n=>used.add(n));
            let bestB=null, bestV=-1; for(let b=1;b<=45;b++){ if(nums.includes(b)) continue; let v=0; for(const n of nums){ v += (coMap.get(Math.min(n,b)+','+Math.max(n,b))||0); } if(v>bestV){ bestV=v; bestB=b; } }
            const sum = nums.reduce((a,b)=>a+b,0), odd = nums.filter(n=>n%2===1).length, high = nums.filter(n=>n>23).length;
            const fit = 100 - (Math.min(Math.abs(sum-145),25)/25*100*0.4 + Math.min(Math.abs(odd-3),3)/3*100*0.3 + Math.min(Math.abs(high-3),3)/3*100*0.3);
            const freqPct = (nums.reduce((acc,n)=>acc+fnorm[n],0)/6)*100, coPct = (nums.reduce((acc,n)=>acc+cnorm[n],0)/6)*100;
            const rationale = { freq: Math.round(freqPct), co: Math.round(coPct), fit: Math.round(fit), overall: Math.round((alpha*freqPct + (1-alpha)*coPct)*0.6 + fit*0.4) };
            out.push({nums, bonus: (bestB||1+Math.floor(Math.random()*45)), rationale});
          }
          return out.sort((a,b)=>b.rationale.overall - a.rationale.overall);
        })(src, FREQ, coMap, N, alpha, 5);

        const left = byId('predBalls'); left.innerHTML='';
        const right = byId('predTable');

        const rowsForTable = [];
        sets.forEach((s,idx)=>{
          const card = document.createElement('div');
          card.className='card';
          card.innerHTML = `<b>#${idx+1}</b>${ballsHtml(s.nums, true, s.bonus)}`;
          left.appendChild(card);
          rowsForTable.push({'ì„¸íŠ¸':'#'+(idx+1), 'ë¹ˆë„ê¸°ì—¬%': s.rationale.freq+'%', 'ê³µì¶œí˜„ê¸°ì—¬%': s.rationale.co+'%', 'êµ¬ì¡°ì í•©%': s.rationale.fit+'%', 'ì¢…í•©%': s.rationale.overall+'%'});
        });
        renderTable(right, rowsForTable, ['ì„¸íŠ¸','ë¹ˆë„ê¸°ì—¬%','ê³µì¶œí˜„ê¸°ì—¬%','êµ¬ì¡°ì í•©%','ì¢…í•©%']);
        byId('predErr').style.display='none';
      }catch(e){ byId('predErr').style.display='block'; byId('predErr').textContent='ì˜ˆì¸¡ ì˜¤ë¥˜: '+e.message; }
    }

    // ===== ë¡œë“œ í”Œë¡œìš° =====
    async function init(){
      try{
        const latest = await api('/api/latest'); LATEST = latest.latest; byId('latest').textContent = LATEST;
        populateRoundList(LATEST);
      }catch(e){ /* pass */ }

      try{
        const start = Math.max(1, (LATEST||1) - 199);
        const j = await api(`/api/all?start=${start}&end=${LATEST||start}`);
        BASE = computeFeatures(j.rows);
        FREQ = frequency(BASE);
        byId('dataStatus').textContent = 'ìµœê·¼ 200íšŒ';
        renderGroupFreq();
        renderRecentTable();
        await drawNetHandler();
        runRecs();
        runPredict();
      }catch(e){
        byId('recentErr').style.display='block'; byId('recentErr').textContent='ìµœê·¼ 200íšŒ ë¡œë“œ ì˜¤ë¥˜: '+e.message;
      }

      byId('loadAll').addEventListener('click', loadFullInBackground);
      byId('netBtn').addEventListener('click', drawNetHandler);
      byId('refreshTable').addEventListener('click', renderRecentTable);
      byId('jumpBtn').addEventListener('click', jumpToRound);
      byId('predictBtn').addEventListener('click', runPredict);
    }

    async function drawNetHandler(){
      try{
        const N = parseInt(byId('lastN')?.value || '10',10);
        const topK = parseInt(byId('topK')?.value || '40',10);
        const src = (ALL.length ? ALL : BASE);
        const map = buildCoMap(src.slice(-N));
        await drawNetwork(map, topK);
        byId('netErr').style.display='none';
      }catch(e){ byId('netErr').style.display='block'; byId('netErr').textContent='ë„¤íŠ¸ì›Œí¬ í‘œì‹œ ì˜¤ë¥˜: '+e.message; }
    }

    async function loadFullInBackground(){
      try{
        byId('dataStatus').textContent = 'ì „ì²´(ë¡œë”© ì¤‘)';
        const full = await api('/api/all');
        ALL = computeFeatures(full.rows);
        FREQ = frequency(ALL);
        byId('dataStatus').textContent = 'ì „ì²´(ì™„ë£Œ)';
        renderGroupFreq();
        await drawNetHandler();
        runRecs();
        runPredict();
      }catch(e){
        byId('dataStatus').textContent = 'ìµœê·¼ 200íšŒ(ìœ ì§€)';
        console.error(e);
      }
    }

    init();
  </script>
</body>
</html>
